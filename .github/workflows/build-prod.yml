name: build ios-dev

on:
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest
    env:
      SHEME: Runner
      BUILD_CONFIGURATION: Release

    steps:
      - name: Checkout the code
        uses: actions/checkout@v2

      - name: Prepare for build
        run: |
          KEYCHAIN_PASSWORD="${{ secrets.KEYCHAIN_PASSWORD }}"
          SSH_PRIVATE_KEY="${{ secrets.SSH_PRIVATE_KEY }}"
          APP_GIT_URL="${{ secrets.APP_GIT_URL }}"
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-add ~/.ssh/id_rsa
          GIT_CURL_VERBOSE=1 git clone "$APP_GIT_URL"
          # 截取仓库名
          repo_name=$(basename "$APP_GIT_URL" .git)
          echo "仓库名$repo_name"
          mv "$repo_name"/* .
          mkdir .github/cert
          mv "$repo_name"/.github/cert/* .github/cert/
          chmod +x .github/script/init-cert.sh
          # 执行脚本安装证书
          source .github/script/init-cert.sh prod

      - name: Install and set Flutter version
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.7.5'

      - name: Restore packages
        run: flutter pub get

      - name: pod repo update
        run: pod repo update

      - name: Build Flutter
        run: flutter build ios --release --no-codesign

      - name: Build resolve Swift dependencies
        run: xcodebuild -resolvePackageDependencies -workspace ios/Runner.xcworkspace -scheme ${{ env.SHEME }} -configuration ${{ env.BUILD_CONFIGURATION }}

      - name: Build xArchive
        run: |
          xcodebuild -workspace ios/Runner.xcworkspace -scheme ${{ env.SHEME }} -configuration ${{ env.BUILD_CONFIGURATION }} DEVELOPMENT_TEAM=$TEAM_ID_APP -sdk 'iphoneos16.2' -destination 'generic/platform=iOS' -archivePath build-output/app.xcarchive PROVISIONING_PROFILE=$PROVISIONING_PROFILE_APP clean archive CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY_APP"
      - name: Export ipa
        run: xcodebuild -exportArchive -archivePath build-output/app.xcarchive -exportPath build-output/ios -exportOptionsPlist ios/ExportOptions.plist

      - name: push ipa to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: build-output/ios/
          target: /home/ios
